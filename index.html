<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maahipaglu's cutu cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Indie+Flower&family=Patrick+Hand&display=swap');
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Patrick Hand', cursive;
            background-color: #f5e6d3;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 4px);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Custom Scrollbar for Gallery */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5e6d3; }
        ::-webkit-scrollbar-thumb { background: #ffb3d9; border-radius: 4px; }

        .handwritten { font-family: 'Indie Flower', cursive; }
        
        .polaroid {
            background: white;
            padding: 12px;
            padding-bottom: 40px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: rotate(-2deg);
            transition: transform 0.3s;
        }
        .polaroid:hover { transform: rotate(0deg) scale(1.02); }
        
        .green-card {
            background: linear-gradient(135deg, #a8b899 0%, #8b9d7c 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .rotating-lyrics { animation: fadeInOut 4s infinite; }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffb3d9 0%, #ffc9e3 100%);
            padding: 20px 40px;
            border-radius: 20px;
            border: 3px solid #ff69b4;
            box-shadow: 0 8px 16px rgba(255, 105, 180, 0.4);
            z-index: 9999;
            animation: errorFade 2s ease-in-out forwards;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d2d2d;
            pointer-events: none;
            text-align: center;
        }
        
        @keyframes errorFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .hidden { display: none !important; }
        
        /* Loading Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ffb3d9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #8b6f47;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 768px) {
            .login-main-container { flex-direction: column !important; padding: 20px !important; }
            .welcome-box { position: static !important; transform: none !important; margin: 20px auto !important; max-width: 90% !important; }
            .pink-input-container { position: static !important; width: 100% !important; margin: 20px auto !important; }
            .arrow-button { position: static !important; margin: 20px auto !important; display: block !important; }
            .flower-photo { display: none !important; }
            .ghost-mascot { position: static !important; margin: 40px auto 20px !important; }
            .decorative-element { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">

    <div id="LOGIN_MAIN" class="screen w-full h-screen flex items-center justify-center p-0 m-0">
        <div class="login-main-container relative w-full h-full" style="background: linear-gradient(to right, #f5e6d3 0%, #f5e6d3 35%, #e8d5c4 35%, #e8d5c4 100%);">
            
            <div class="decorative-element absolute top-8 left-8">
                <svg width="120" height="80" viewBox="0 0 120 80">
                    <path d="M 10 40 Q 10 10 40 10 L 80 10 Q 110 10 110 40 Q 110 70 80 70 L 40 70 Q 10 70 10 40" stroke="#ff9999" stroke-width="2" fill="none" opacity="0.6"/>
                </svg>
            </div>
            
            <div class="welcome-box absolute top-12 left-12" style="max-width: 280px;">
                <div style="position: absolute; top: -25px; right: 20px; z-index: 10;">
                    <svg width="60" height="60" viewBox="0 0 60 60">
                        <ellipse cx="20" cy="30" rx="15" ry="10" fill="#ffb3d9"/>
                        <ellipse cx="40" cy="30" rx="15" ry="10" fill="#ffb3d9"/>
                        <circle cx="30" cy="30" r="7" fill="#ff99cc"/>
                    </svg>
                </div>
                <div class="relative" style="background: rgba(240, 235, 225, 0.95); padding: 24px 32px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transform: rotate(-1deg); border: 1px solid rgba(210, 180, 140, 0.3);">
                    <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; line-height: 1.1; color: #2d2d2d;">welcome deviji</h1>
                    <p style="font-size: 1.1rem; line-height: 1.4; color: #3d3d3d;">enter the secret word<br>to unlock the<br>magical memories</p>
                </div>
            </div>

            <div class="flower-photo absolute" style="top: 52%; left: 80px;">
                <div style="background: white; padding: 12px; padding-bottom: 35px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transform: rotate(-3deg); width: 160px;">
                    <img id="login-preview-img" src="" alt="Loading..." style="width: 136px; height: 136px; object-fit: cover; display: block; background: #eee;">
                </div>
            </div>

            <div class="pink-input-container absolute" style="top: 20%; right: 8%; width: 480px;">
                <div style="background: linear-gradient(135deg, #ffb3d9 0%, #ffc9e3 100%); border-radius: 2rem; padding: 24px 28px; box-shadow: 0 6px 12px rgba(255, 182, 193, 0.4);">
                    <div class="flex items-center gap-4" style="flex-wrap: wrap;">
                        <label style="font-size: 1.4rem; font-weight: bold; white-space: nowrap; color: #2d2d2d;">Sarvesh likes?</label>
                        <input type="text" id="ownerPassword" style="flex: 1; min-width: 150px; padding: 14px 20px; border-radius: 1.5rem; background: #fffacd; border: none; font-size: 1.1rem; outline: none; color: #2d2d2d;" placeholder="type the correct word here...">
                    </div>
                </div>
            </div>

            <div class="arrow-button absolute" style="top: 21.5%; right: 14%;">
                <button onclick="submitOwnerLogin()" style="width: 70px; height: 70px; border-radius: 50%; background: #8b6f47; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s ease;">
                    <span style="color: white; font-size: 2rem; font-weight: bold;">‚Üí</span>
                </button>
            </div>

            <div class="ghost-mascot absolute" style="bottom: 6%; right: 5%;">
                <div class="text-center cursor-pointer" onclick="showScreen('LOGIN_STRANGER')" style="transition: transform 0.3s ease;">
                    <div style="position: relative; width: 70px; height: 85px; margin: 0 auto 6px;">
                        <div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 65px; height: 75px; background: white; border-radius: 35px 35px 0 0; box-shadow: 0 3px 6px rgba(0,0,0,0.1);">
                            <div style="position: absolute; top: 22px; left: 16px; width: 8px; height: 8px; background: black; border-radius: 50%;"></div>
                            <div style="position: absolute; top: 22px; right: 16px; width: 8px; height: 8px; background: black; border-radius: 50%;"></div>
                            <div style="position: absolute; top: 28px; left: 8px; width: 12px; height: 6px; background: #ffb3d9; border-radius: 50%; opacity: 0.6;"></div>
                            <div style="position: absolute; top: 28px; right: 8px; width: 12px; height: 6px; background: #ffb3d9; border-radius: 50%; opacity: 0.6;"></div>
                            <div style="position: absolute; top: 40px; left: 50%; transform: translateX(-50%); width: 30px; height: 15px; border: 2.5px solid black; border-top: none; border-radius: 0 0 15px 15px;"></div>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; font-weight: 600; color: #2d2d2d; line-height: 1.2;">Stranger<br>login</p>
                </div>
            </div>
        </div>
    </div>

    <div id="LOGIN_STRANGER" class="screen hidden w-full h-screen flex items-center justify-center p-0 m-0">
        <div class="relative w-full h-full flex items-center justify-center" style="background: linear-gradient(to bottom, #f5e6d3 0%, #e8d5c4 100%);">
            <button onclick="showScreen('LOGIN_MAIN')" style="position: absolute; top: 20px; left: 20px; padding: 10px 20px; background: #8b6f47; color: white; border: none; border-radius: 20px; cursor: pointer;">‚Üê Back</button>
            <div style="text-align: center;">
                <h2 style="font-size: 2rem; color: #2d2d2d; margin-bottom: 20px;" class="handwritten">Stranger Access</h2>
                <div style="background: white; border: 6px solid #8b7fb8; border-radius: 2.5rem; padding: 22px 35px; margin-bottom: 20px;">
                    <input type="text" id="strangerCode" style="width: 100%; border: none; outline: none; font-size: 1.6rem; color: #666; background: transparent; text-align: center;" placeholder="Enter Code">
                </div>
                <button onclick="submitStrangerLogin()" style="background: #8b6f47; color: white; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; border: none; cursor: pointer;">Enter</button>
            </div>
        </div>
    </div>

    <div id="DASHBOARD" class="screen hidden w-full h-screen p-0 m-0" style="background-color: #f5e6d3; overflow-y: auto;">
        <div class="relative w-full min-h-screen p-8">
            <button onclick="showScreen('LOGIN_MAIN')" style="position: absolute; top: 20px; left: 20px; z-index: 50; padding: 8px 16px; background: #8b6f47; color: white; border-radius: 20px; cursor: pointer;">Logout</button>
            <button id="settingsButton" onclick="showScreen('SETTINGS')" style="position: absolute; top: 20px; right: 20px; z-index: 50; padding: 8px 16px; background: #8b6f47; color: white; border-radius: 20px; cursor: pointer; display: none;">‚öôÔ∏è Settings</button>
            
            <div class="flex flex-wrap items-start gap-8 pt-8 px-8 justify-center" style="max-width: 1200px; margin: 0 auto;">
                
                <div style="flex-shrink: 0; width: 240px;">
                    <div class="polaroid" style="width: 200px; margin-bottom: 30px;">
                        <img id="dashboardPhoto" src="" alt="Loading..." style="width: 176px; height: 176px; object-fit: cover; display: block; background: #eee;">
                    </div>
                    <div class="bg-white/90 p-6 rounded shadow rotate-[-1deg] border border-stone-300">
                        <p class="text-lg" id="noteDisplay" style="color: #2d2d2d;">Your special memories live here... ‚ú®</p>
                    </div>
                </div>
                
                <div style="flex: 1; max-width: 650px;">
                    <div class="green-card rounded-3xl p-8 text-white mb-8" style="min-height: 220px;">
                        <!-- Spotify Player -->
                        <div id="spotifyPlayer" style="width: 100%; height: 352px;">
                            <iframe 
                                id="spotifyEmbed" 
                                style="border-radius: 12px; width: 100%; height: 100%;" 
                                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                                loading="lazy"
                                src="">
                            </iframe>
                        </div>
                        <!-- Lyrics Display (Hidden by default, can be toggled) -->
                        <div id="lyricsDisplay" class="rotating-lyrics hidden">
                            <h3 class="text-2xl font-bold mb-4" id="songTitle">Tere Bina</h3>
                            <p class="text-base leading-relaxed" id="songLyrics">
                                Every moment with you feels like magic<br>
                                Your smile lights up my darkest days...
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-center mb-8">
                        <div class="bg-white px-8 py-3 rounded-full border-2 border-black inline-block shadow">
                            <p class="text-2xl font-bold text-gray-800">Hi <span id="username">User</span> üëã</p>
                        </div>
                    </div>
                    
                    <div class="ml-auto w-fit cursor-pointer hover:scale-105 transition-transform" onclick="showScreen('GALLERY')">
                        <div class="relative w-36 h-28 bg-pink-300 rounded-lg shadow-md flex items-center justify-center">
                            <div class="absolute -top-3 left-0 w-16 h-6 bg-pink-300 rounded-t-lg"></div>
                            <p class="font-bold text-gray-700 mt-2">All Pics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="SETTINGS" class="screen hidden w-full h-screen p-8" style="background-color: #f5e6d3; overflow-y: auto;">
        <div class="max-w-2xl mx-auto">
            <div class="mb-6">
                <button onclick="showScreen('DASHBOARD')" class="bg-[#8b6f47] px-6 py-2 rounded-full text-white hover:bg-[#6b5435] transition cursor-pointer">‚Üê Back</button>
            </div>
            
            <div class="bg-white rounded-3xl p-8 shadow-lg border border-stone-300">
                <h2 class="text-3xl font-bold mb-6 text-center" style="color: #2d2d2d;">Settings ‚öôÔ∏è</h2>
                
                <div class="space-y-6">
                    <!-- Stranger Login Toggle -->
                    <div class="bg-purple-50 rounded-2xl p-6 border-2 border-purple-200">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-xl font-bold" style="color: #2d2d2d;">Stranger Login</h3>
                                <p class="text-sm text-gray-600 mt-1">Enable or disable stranger login access</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="strangerLoginToggle" onchange="toggleStrangerLogin()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Stranger Password -->
                    <div class="bg-blue-50 rounded-2xl p-6 border-2 border-blue-200">
                        <h3 class="text-xl font-bold mb-4" style="color: #2d2d2d;">Stranger Password</h3>
                        <p class="text-sm text-gray-600 mb-3">Change the code required for stranger login</p>
                        <div class="flex gap-3">
                            <input type="text" id="strangerPasswordInput" placeholder="Enter new code" 
                                class="flex-1 px-4 py-2 rounded-lg border-2 border-blue-300 focus:outline-none focus:border-blue-500" 
                                style="background: white; color: #2d2d2d;">
                            <button onclick="saveStrangerPassword()" 
                                class="bg-blue-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-600 transition cursor-pointer">
                                Save
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard Note -->
                    <div class="bg-green-50 rounded-2xl p-6 border-2 border-green-200">
                        <h3 class="text-xl font-bold mb-4" style="color: #2d2d2d;">Dashboard Note</h3>
                        <p class="text-sm text-gray-600 mb-3">Edit the message shown on the dashboard</p>
                        <textarea id="dashboardNoteInput" rows="3" placeholder="Enter your note..." 
                            class="w-full px-4 py-2 rounded-lg border-2 border-green-300 focus:outline-none focus:border-green-500 resize-none" 
                            style="background: white; color: #2d2d2d;"></textarea>
                        <button onclick="saveDashboardNote()" 
                            class="mt-3 bg-green-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-600 transition cursor-pointer">
                            Save Note
                        </button>
                    </div>

                    <!-- Spotify Player -->
                    <div class="bg-pink-50 rounded-2xl p-6 border-2 border-pink-200">
                        <h3 class="text-xl font-bold mb-4" style="color: #2d2d2d;">üéµ Spotify Player</h3>
                        <p class="text-sm text-gray-600 mb-3">Add a Spotify song, album, or playlist to play on dashboard</p>
                        <p class="text-xs text-gray-500 mb-3">Paste Spotify URL (e.g., https://open.spotify.com/track/...)</p>
                        <input type="text" id="spotifyUrlInput" placeholder="https://open.spotify.com/track/..." 
                            class="w-full px-4 py-2 rounded-lg border-2 border-pink-300 focus:outline-none focus:border-pink-500" 
                            style="background: white; color: #2d2d2d;">
                        <button onclick="saveSpotifyUrl()" 
                            class="mt-3 bg-pink-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-pink-600 transition cursor-pointer">
                            Save Spotify URL
                        </button>
                        <button onclick="clearSpotifyUrl()" 
                            class="mt-2 bg-gray-400 text-white px-6 py-2 rounded-lg font-bold hover:bg-gray-500 transition cursor-pointer">
                            Clear Player
                        </button>
                    </div>

                    <!-- Add Photo to Gallery -->
                    <div class="bg-orange-50 rounded-2xl p-6 border-2 border-orange-200">
                        <h3 class="text-xl font-bold mb-4" style="color: #2d2d2d;">üì∏ Add Photo to Gallery</h3>
                        <p class="text-sm text-gray-600 mb-3">Upload an image to convert to Base64 and add to your gallery</p>
                        
                        <div class="mb-4">
                            <input type="file" id="photoUpload" accept="image/*" onchange="handlePhotoUpload(event)" 
                                class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:border-orange-500 cursor-pointer" 
                                style="background: white; color: #2d2d2d;">
                        </div>

                        <div id="photoPreviewContainer" class="hidden mb-4">
                            <p class="text-sm font-bold mb-2" style="color: #2d2d2d;">Preview:</p>
                            <img id="photoPreview" src="" alt="Preview" 
                                class="max-w-full h-auto rounded-lg border-2 border-orange-300" 
                                style="max-height: 200px; object-fit: contain;">
                        </div>

                        <div id="base64Container" class="hidden mb-4">
                            <p class="text-sm font-bold mb-2" style="color: #2d2d2d;">Base64 String:</p>
                            <div class="flex gap-2">
                                <textarea id="base64Output" rows="4" readonly
                                    class="flex-1 px-4 py-2 rounded-lg border-2 border-orange-300 bg-gray-50 text-xs font-mono" 
                                    style="color: #2d2d2d;"></textarea>
                                <button onclick="copyBase64()" 
                                    class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-600 transition cursor-pointer whitespace-nowrap">
                                    Copy
                                </button>
                            </div>
                            <div class="mt-3">
                                <input type="number" id="photoIndexInput" placeholder="Photo number (e.g., 1, 2, 3...)" min="1"
                                    class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:border-orange-500" 
                                    style="background: white; color: #2d2d2d;">
                                <p class="text-xs text-gray-500 mt-1">Enter the photo number (will be saved as photos/X.txt in GitHub)</p>
                            </div>
                            <button onclick="savePhotoToLocal()" 
                                class="mt-3 bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-600 transition cursor-pointer">
                                Save to Local Storage
                            </button>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-100 rounded-lg border border-yellow-300">
                            <p class="text-xs font-bold mb-2" style="color: #2d2d2d;">üìù How to add to GitHub:</p>
                            <ol class="text-xs text-gray-700 list-decimal list-inside space-y-1">
                                <li>Upload image above and copy the Base64 string</li>
                                <li>Go to your GitHub repo ‚Üí photos folder</li>
                                <li>Create a new file: <code class="bg-white px-1 rounded">X.txt</code> (X = photo number)</li>
                                <li>Paste the Base64 string into the file</li>
                                <li>Commit and push to GitHub</li>
                                <li>The photo will appear in your gallery!</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="GALLERY" class="screen hidden w-full h-screen p-8" style="background-color: #f5e6d3; overflow-y: auto;">
        <div class="max-w-4xl mx-auto">
            <div class="mb-6">
                <button onclick="showScreen('DASHBOARD')" class="bg-[#8b6f47] px-6 py-2 rounded-full text-white hover:bg-[#6b5435] transition cursor-pointer">‚Üê Back</button>
            </div>
            
            <div id="gallery-loading" class="text-center py-10">
                <div class="loader"></div>
                <p>Decoding Memories...</p>
            </div>

            <div id="gallery-grid" class="bg-pink-100 rounded-3xl p-8 min-h-96 relative flex flex-wrap gap-6 justify-center hidden">
                </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            ownerPassword: "kuchupuchu",
            strangerCode: "6000302",
            users: { owner: "Maahi", stranger: "Stranger" },
            flowerImage: "pics/flower.jpg", // Path to flower image in pics folder
            spotifyEmbedUrl: "" // Spotify embed URL (song, album, or playlist)
        };

        // Track current user type
        let currentUserType = null; // 'owner' or 'stranger'

        // --- NAVIGATION & INIT ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.add('hidden');
                s.classList.remove('flex');
            });

            const target = document.getElementById(screenId);
            if (target) {
                target.classList.remove('hidden');
                if (screenId.includes('LOGIN')) target.classList.add('flex');
            }
            
            // Show/hide settings button based on user type
            const settingsButton = document.getElementById('settingsButton');
            if (settingsButton) {
                if (screenId === 'DASHBOARD' && currentUserType === 'owner') {
                    settingsButton.style.display = 'block';
                } else {
                    settingsButton.style.display = 'none';
                }
            }

            // Load settings when opening settings screen
            if (screenId === 'SETTINGS') {
                loadSettings();
            }
            
            // Load Spotify player when showing dashboard
            if (screenId === 'DASHBOARD') {
                loadSpotifyPlayer();
            }
            
            // Update stranger login visibility when showing login screen
            if (screenId === 'LOGIN_MAIN') {
                const strangerLoginEnabled = localStorage.getItem('strangerLoginEnabled') !== 'false';
                updateStrangerLoginVisibility(strangerLoginEnabled);
            }
            
            // Clear inputs
            if(screenId === 'LOGIN_MAIN') {
                document.getElementById('ownerPassword').value = '';
                document.getElementById('strangerCode').value = '';
                currentUserType = null; // Reset on logout
            }

            // Trigger Gallery Load only when opening Gallery
            if(screenId === 'GALLERY') {
                loadGalleryImages();
            }
        }

        // --- IMAGE FETCHING LOGIC ---
        let galleryLoaded = false;

        async function loadGalleryImages() {
            if (galleryLoaded) return;

            const galleryGrid = document.getElementById('gallery-grid');
            const loader = document.getElementById('gallery-loading');
            
            loader.classList.remove('hidden');
            galleryGrid.classList.add('hidden');

            // First, load photos from localStorage (locally saved)
            const photoList = JSON.parse(localStorage.getItem('photoList') || '[]');
            if (photoList.length > 0) {
                for (const photoIndex of photoList) {
                    const base64Data = localStorage.getItem(`photo_${photoIndex}`);
                    if (base64Data) {
                        createGalleryItem(base64Data, photoIndex);
                        // Update preview with first local photo
                        if (photoIndex === Math.min(...photoList)) {
                            updatePreviewImages(base64Data);
                        }
                    }
                }
            }

            // Then, load photos from GitHub repo (photos folder)
            let index = 1;
            let keepFetching = true;
            let firstGitHubPhoto = null;

            // Maximum safety limit of 50 photos to prevent infinite loops
            while (keepFetching && index < 50) {
                try {
                    // Skip if already loaded from localStorage
                    if (photoList.includes(index)) {
                        index++;
                        continue;
                    }

                    const response = await fetch(`photos/${index}.txt`);
                    
                    if (!response.ok) {
                        keepFetching = false;
                        break;
                    }

                    const base64Data = await response.text();
                    createGalleryItem(base64Data, index);
                    
                    // Store first GitHub photo for preview
                    if (!firstGitHubPhoto) {
                        firstGitHubPhoto = base64Data;
                    }

                    index++;
                } catch (error) {
                    console.log("Finished loading images or error:", error);
                    keepFetching = false;
                }
            }

            // Update preview with first GitHub photo if no local photos
            if (firstGitHubPhoto && photoList.length === 0) {
                updatePreviewImages(firstGitHubPhoto);
            }

            loader.classList.add('hidden');
            galleryGrid.classList.remove('hidden');
            galleryLoaded = true;
        }

        function isValidBase64(str) {
            // Remove data URI prefix if present
            const base64Part = str.includes(',') ? str.split(',')[1] : str;
            // Check if it's valid Base64 (only contains A-Z, a-z, 0-9, +, /, =)
            const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
            return base64Part.length > 0 && base64Regex.test(base64Part);
        }

        function detectImageType(base64String) {
            // Check for PNG signature
            if (base64String.startsWith('iVBORw0KGgo') || base64String.includes('iVBORw0KGgo')) {
                return 'png';
            }
            // Check for JPEG signature
            if (base64String.startsWith('/9j/') || base64String.includes('/9j/')) {
                return 'jpeg';
            }
            // Check for GIF signature
            if (base64String.startsWith('R0lGOD') || base64String.includes('R0lGOD')) {
                return 'gif';
            }
            // Default to jpeg
            return 'jpeg';
        }

        function createGalleryItem(base64String, index) {
            // Remove all line breaks/enters from the text file and trim whitespace
            let cleanStr = base64String.replace(/(\r\n|\n|\r)/gm, "").trim();

            // Check if string is empty or too short
            if (!cleanStr || cleanStr.length < 50) {
                showErrorItem(index, "File is empty or too short");
                return;
            }

            // Extract base64 part if data URI is present
            let base64Data = cleanStr;
            let imageType = 'jpeg';
            
            if (cleanStr.startsWith('data:image')) {
                // Extract type and data
                const match = cleanStr.match(/data:image\/(\w+);base64,(.+)/);
                if (match) {
                    imageType = match[1];
                    base64Data = match[2];
                } else {
                    // Try to extract just the base64 part after comma
                    const parts = cleanStr.split(',');
                    if (parts.length > 1) {
                        base64Data = parts[parts.length - 1];
                    }
                }
            } else {
                // Try to detect image type from base64 content
                imageType = detectImageType(base64Data);
            }

            // Validate Base64 format
            if (!isValidBase64(base64Data)) {
                showErrorItem(index, "Invalid Base64 format");
                return;
            }

            // Construct the data URI
            cleanStr = `data:image/${imageType};base64,${base64Data}`;

            const wrapper = document.createElement('div');
            // Randomize rotation slightly for cute effect
            const rotate = (Math.random() * 6) - 3; 
            wrapper.className = "w-48 h-48 bg-white p-2 shadow-md transition hover:scale-110 duration-300";
            wrapper.style.transform = `rotate(${rotate}deg)`;

            const img = document.createElement('img');
            img.src = cleanStr;
            img.className = "w-full h-full object-cover";
            img.alt = `Memory ${index}`;
            
            // Add a visual error handler for debugging
            img.onerror = function() {
                console.error(`Image ${index} failed to load. Check Base64 string in photos/${index}.txt`);
                showErrorItem(index, "Image failed to decode");
            };

            img.onload = function() {
                console.log(`Image ${index} loaded successfully`);
            };

            wrapper.appendChild(img);
            document.getElementById('gallery-grid').appendChild(wrapper);
        }

        function showErrorItem(index, message) {
            const wrapper = document.createElement('div');
            const rotate = (Math.random() * 6) - 3; 
            wrapper.className = "w-48 h-48 bg-red-100 p-2 shadow-md border-2 border-red-300";
            wrapper.style.transform = `rotate(${rotate}deg)`;
            wrapper.innerHTML = `<div class="flex flex-col items-center justify-center w-full h-full text-xs text-red-700 text-center p-2">
                <div class="font-bold mb-1">Photo ${index}</div>
                <div>${message}</div>
                <div class="text-[10px] mt-1 opacity-75">Check photos/${index}.txt</div>
            </div>`;
            document.getElementById('gallery-grid').appendChild(wrapper);
        }

        function updatePreviewImages(base64String) {
            let cleanStr = base64String.replace(/(\r\n|\n|\r)/gm, "").trim();
            
            // Validate before using
            if (!cleanStr || cleanStr.length < 50) {
                console.warn("Preview image data is empty or too short");
                return;
            }

            let base64Data = cleanStr;
            let imageType = 'jpeg';
            
            if (cleanStr.startsWith('data:image')) {
                const match = cleanStr.match(/data:image\/(\w+);base64,(.+)/);
                if (match) {
                    imageType = match[1];
                    base64Data = match[2];
                } else {
                    const parts = cleanStr.split(',');
                    if (parts.length > 1) {
                        base64Data = parts[parts.length - 1];
                    }
                }
            } else {
                imageType = detectImageType(base64Data);
            }

            if (!isValidBase64(base64Data)) {
                console.warn("Preview image has invalid Base64 format");
                return;
            }

            cleanStr = `data:image/${imageType};base64,${base64Data}`;
            
            // Note: Login flower is loaded separately from pics folder, don't override it
            
            // Update dashboard polaroid only
            const dashImg = document.getElementById('dashboardPhoto');
            if(dashImg) {
                dashImg.onerror = function() {
                    console.warn("Dashboard preview image failed to load");
                    dashImg.style.display = 'none';
                };
                dashImg.src = cleanStr;
            }
        }

        // --- AUTH LOGIC ---
        function submitOwnerLogin() {
            const input = document.getElementById('ownerPassword').value.trim().toLowerCase();
            if (input === CONFIG.ownerPassword) {
                currentUserType = 'owner';
                document.getElementById('username').innerText = CONFIG.users.owner;
                showScreen('DASHBOARD');
                loadGalleryImages(); 
            } else {
                showError("Galat jawab! üôà Try something else");
            }
        }

        function submitStrangerLogin() {
            const input = document.getElementById('strangerCode').value.trim();
            if (input === CONFIG.strangerCode) {
                currentUserType = 'stranger';
                document.getElementById('username').innerText = CONFIG.users.stranger;
                showScreen('DASHBOARD');
                loadGalleryImages();
            } else {
                showError("Wrong code! üò§");
            }
        }

        function showError(message) {
            const existing = document.querySelector('.error-message');
            if (existing) existing.remove();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'error-message';
            msgDiv.innerHTML = message;
            document.body.appendChild(msgDiv);
            setTimeout(() => { if (msgDiv) msgDiv.remove(); }, 2000);
        }

        // --- SETTINGS MANAGEMENT ---
        function loadSettings() {
            // Load stranger login enabled state
            const strangerLoginEnabled = localStorage.getItem('strangerLoginEnabled') !== 'false'; // Default to true
            const toggle = document.getElementById('strangerLoginToggle');
            if (toggle) {
                toggle.checked = strangerLoginEnabled;
            }
            updateStrangerLoginVisibility(strangerLoginEnabled);

            // Load stranger password
            const savedStrangerCode = localStorage.getItem('strangerCode');
            if (savedStrangerCode) {
                CONFIG.strangerCode = savedStrangerCode;
            }
            const passwordInput = document.getElementById('strangerPasswordInput');
            if (passwordInput) {
                passwordInput.value = CONFIG.strangerCode;
            }

            // Load dashboard note
            const savedNote = localStorage.getItem('dashboardNote');
            if (savedNote) {
                const noteDisplay = document.getElementById('noteDisplay');
                if (noteDisplay) {
                    noteDisplay.innerText = savedNote;
                }
            }
            const noteInput = document.getElementById('dashboardNoteInput');
            if (noteInput) {
                noteInput.value = savedNote || 'Your special memories live here... ‚ú®';
            }

            // Load Spotify URL
            const savedSpotifyUrl = localStorage.getItem('spotifyEmbedUrl');
            const spotifyUrlInput = document.getElementById('spotifyUrlInput');
            if (spotifyUrlInput) {
                spotifyUrlInput.value = savedSpotifyUrl || '';
            }
        }

        function toggleStrangerLogin() {
            const toggle = document.getElementById('strangerLoginToggle');
            const isEnabled = toggle.checked;
            localStorage.setItem('strangerLoginEnabled', isEnabled);
            updateStrangerLoginVisibility(isEnabled);
            showError(isEnabled ? "Stranger login enabled ‚úÖ" : "Stranger login disabled üîí");
        }

        function updateStrangerLoginVisibility(isEnabled) {
            const ghostMascot = document.querySelector('.ghost-mascot');
            if (ghostMascot) {
                ghostMascot.style.display = isEnabled ? 'block' : 'none';
            }
        }

        function saveStrangerPassword() {
            const input = document.getElementById('strangerPasswordInput');
            const newCode = input.value.trim();
            if (!newCode) {
                showError("Please enter a code!");
                return;
            }
            CONFIG.strangerCode = newCode;
            localStorage.setItem('strangerCode', newCode);
            showError("Stranger password saved! ‚úÖ");
        }

        function saveDashboardNote() {
            const input = document.getElementById('dashboardNoteInput');
            const newNote = input.value.trim();
            if (!newNote) {
                showError("Please enter a note!");
                return;
            }
            localStorage.setItem('dashboardNote', newNote);
            const noteDisplay = document.getElementById('noteDisplay');
            if (noteDisplay) {
                noteDisplay.innerText = newNote;
            }
            showError("Dashboard note saved! ‚úÖ");
        }

        function saveSpotifyUrl() {
            const input = document.getElementById('spotifyUrlInput');
            const spotifyUrl = input.value.trim();
            if (!spotifyUrl) {
                showError("Please enter a Spotify URL!");
                return;
            }
            
            // Validate Spotify URL
            if (!spotifyUrl.includes('spotify.com')) {
                showError("Please enter a valid Spotify URL!");
                return;
            }
            
            localStorage.setItem('spotifyEmbedUrl', spotifyUrl);
            loadSpotifyPlayer(); // Reload the player
            showError("Spotify URL saved! üéµ");
        }

        function clearSpotifyUrl() {
            localStorage.removeItem('spotifyEmbedUrl');
            const spotifyEmbed = document.getElementById('spotifyEmbed');
            if (spotifyEmbed) {
                spotifyEmbed.src = '';
            }
            const spotifyUrlInput = document.getElementById('spotifyUrlInput');
            if (spotifyUrlInput) {
                spotifyUrlInput.value = '';
            }
            document.getElementById('spotifyPlayer').style.display = 'none';
            showError("Spotify player cleared! ‚úÖ");
        }

        // --- PHOTO UPLOAD & BASE64 CONVERSION ---
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError("Please select an image file!");
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError("Image too large! Please use images under 5MB.");
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64String = e.target.result;
                const preview = document.getElementById('photoPreview');
                const previewContainer = document.getElementById('photoPreviewContainer');
                const base64Container = document.getElementById('base64Container');
                const base64Output = document.getElementById('base64Output');

                // Show preview
                preview.src = base64String;
                previewContainer.classList.remove('hidden');

                // Extract just the base64 data (remove data:image/...;base64, prefix)
                let base64Data = base64String;
                if (base64String.includes(',')) {
                    base64Data = base64String.split(',')[1];
                }

                // Show base64 string
                base64Output.value = base64Data;
                base64Container.classList.remove('hidden');

                // Store the full base64 string temporarily for saving
                window.tempPhotoBase64 = base64String;
                window.tempPhotoBase64Data = base64Data;
            };

            reader.onerror = function() {
                showError("Error reading file! Please try again.");
            };

            reader.readAsDataURL(file);
        }

        function copyBase64() {
            const base64Output = document.getElementById('base64Output');
            if (!base64Output || !base64Output.value) {
                showError("No Base64 string to copy!");
                return;
            }

            base64Output.select();
            base64Output.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                showError("Base64 string copied to clipboard! ‚úÖ");
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(base64Output.value).then(() => {
                    showError("Base64 string copied to clipboard! ‚úÖ");
                }).catch(() => {
                    showError("Failed to copy! Please select and copy manually.");
                });
            }
        }

        function savePhotoToLocal() {
            const photoIndex = document.getElementById('photoIndexInput').value.trim();
            if (!photoIndex || isNaN(photoIndex) || parseInt(photoIndex) < 1) {
                showError("Please enter a valid photo number!");
                return;
            }

            if (!window.tempPhotoBase64Data) {
                showError("No photo to save! Please upload an image first.");
                return;
            }

            const index = parseInt(photoIndex);
            const storageKey = `photo_${index}`;
            
            // Save to localStorage
            localStorage.setItem(storageKey, window.tempPhotoBase64Data);
            
            // Also save the mapping of which photos exist
            let photoList = JSON.parse(localStorage.getItem('photoList') || '[]');
            if (!photoList.includes(index)) {
                photoList.push(index);
                photoList.sort((a, b) => a - b);
                localStorage.setItem('photoList', JSON.stringify(photoList));
            }

            showError(`Photo ${index} saved to local storage! ‚úÖ`);
            
            // If gallery is already loaded, add the new photo to it
            const galleryGrid = document.getElementById('gallery-grid');
            if (galleryGrid && !galleryGrid.classList.contains('hidden')) {
                createGalleryItem(window.tempPhotoBase64Data, index);
            }
            
            // Reset form
            document.getElementById('photoUpload').value = '';
            document.getElementById('photoPreviewContainer').classList.add('hidden');
            document.getElementById('base64Container').classList.add('hidden');
            document.getElementById('photoIndexInput').value = '';
            window.tempPhotoBase64 = null;
            window.tempPhotoBase64Data = null;
        }

        function loadFlowerPhoto() {
            // Load flower photo from pics folder
            const flowerImg = document.getElementById('login-preview-img');
            if (!flowerImg) return;
            
            flowerImg.onerror = function() {
                console.log(`Flower image not found at ${CONFIG.flowerImage}`);
                flowerImg.style.display = 'none';
            };
            
            flowerImg.src = CONFIG.flowerImage;
        }

        function loadSpotifyPlayer() {
            // Load Spotify player from localStorage or CONFIG
            const savedSpotifyUrl = localStorage.getItem('spotifyEmbedUrl');
            const spotifyUrl = savedSpotifyUrl || CONFIG.spotifyEmbedUrl;
            const spotifyEmbed = document.getElementById('spotifyEmbed');
            const spotifyPlayer = document.getElementById('spotifyPlayer');
            const lyricsDisplay = document.getElementById('lyricsDisplay');
            
            if (spotifyEmbed && spotifyPlayer) {
                if (spotifyUrl) {
                    // Convert Spotify URL to embed format if needed
                    let embedUrl = spotifyUrl;
                    
                    // If it's a regular Spotify URL, convert to embed format
                    if (spotifyUrl.includes('open.spotify.com') && !spotifyUrl.includes('embed')) {
                        try {
                            // Extract track/album/playlist ID from URL
                            const urlParts = spotifyUrl.split('/');
                            const type = urlParts[3]; // track, album, playlist, etc.
                            const id = urlParts[4] ? urlParts[4].split('?')[0] : null; // Remove query params
                            
                            if (type && id) {
                                embedUrl = `https://open.spotify.com/embed/${type}/${id}?utm_source=generator`;
                            }
                        } catch (e) {
                            console.error("Error parsing Spotify URL:", e);
                            showError("Invalid Spotify URL format!");
                            return;
                        }
                    }
                    
                    // Show Spotify player and hide lyrics
                    spotifyPlayer.style.display = 'block';
                    if (lyricsDisplay) {
                        lyricsDisplay.classList.add('hidden');
                    }
                    spotifyEmbed.src = embedUrl;
                } else {
                    // Hide Spotify player and show lyrics if no URL is set
                    spotifyPlayer.style.display = 'none';
                    if (lyricsDisplay) {
                        lyricsDisplay.classList.remove('hidden');
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            showScreen('LOGIN_MAIN');
            // Load settings on page load
            loadSettings();
            // Load flower photo from pics folder
            loadFlowerPhoto();
            // Try to load first image from photos for dashboard preview
            fetch('photos/1.txt')
                .then(res => {
                    if(res.ok) return res.text();
                    throw new Error('No image');
                })
                .then(data => {
                    // Only update dashboard photo, not login flower
                    const dashImg = document.getElementById('dashboardPhoto');
                    if(dashImg && data) {
                        let cleanStr = data.replace(/(\r\n|\n|\r)/gm, "").trim();
                        if (cleanStr && cleanStr.length >= 50) {
                            let base64Data = cleanStr;
                            let imageType = 'jpeg';
                            
                            if (cleanStr.startsWith('data:image')) {
                                const match = cleanStr.match(/data:image\/(\w+);base64,(.+)/);
                                if (match) {
                                    imageType = match[1];
                                    base64Data = match[2];
                                } else {
                                    const parts = cleanStr.split(',');
                                    if (parts.length > 1) {
                                        base64Data = parts[parts.length - 1];
                                    }
                                }
                            } else {
                                imageType = detectImageType(base64Data);
                            }
                            
                            if (isValidBase64(base64Data)) {
                                dashImg.src = `data:image/${imageType};base64,${base64Data}`;
                            }
                        }
                    }
                })
                .catch(e => console.log("No initial image found (photos/1.txt missing or corrupt)"));
        });
    </script>
</body>
</html>

